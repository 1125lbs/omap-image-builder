=== modified file 'rootstock'
--- rootstock	2010-07-27 13:50:46 +0000
+++ rootstock	2010-07-27 13:59:34 +0000
@@ -233,9 +233,15 @@
 
 create_qemu_image()
 {
+    if [ "$IS_NATIVE" ]; then
+        IMAGENAME="${BUILDDIR}/armel/"
+        mkdir -p ${IMAGENAME}
+        MOUNTPOINT=${IMAGENAME}
+    else
     log "I: Creating temporary qemu Image to be used as rootfs"
     LANG=C qemu-img create $IMAGENAME ${IMAGESIZE}k >$LOG 2>&1
     LANG=C mkfs.ext3 -F $IMAGENAME >>$LOG 2>&1
+	fi
 }
 
 create_rootfs_image()
@@ -253,6 +259,7 @@
 
 mount_image()
 {
+if [ ! "$IS_NATIVE" ]; then
     log "I: Mounting temporary Image"
     if [ ! -d $MOUNTPOINT ];then
         mkdir -p $MOUNTPOINT >>$LOG 2>&1
@@ -262,6 +269,7 @@
     else
         mount -o loop $IMAGENAME $MOUNTPOINT >>$LOG 2>&1
     fi
+fi
 }
 
 umount_image()
@@ -355,6 +363,22 @@
     log "I: First stage install done"
 }
 
+run_arm_chroot()
+{
+    log "I: Using Native ARM Chroot"
+    chroot ${MOUNTPOINT} /bin/installer
+    sync
+    sync
+
+    # recover Host's hostname after chroot messes with it
+    hostname $(cat /etc/hostname)
+
+    umount -l ${MOUNTPOINT}/dev/pts
+    umount -l ${MOUNTPOINT}/proc
+    umount -l ${MOUNTPOINT}/sys
+    log "I: Chroot done"
+}
+
 run_vm()
 {
     # get kernel
@@ -827,6 +851,9 @@
     usage
 fi
 
+ARCH=$(uname -m)
+unset IS_NATIVE
+
 # we need root
 if [ $(id -u) != 0 ] && [ ! "$NOROOT" ];then
     echo "You should run $PROGRAM as root unless you explicitly request it by giving --no-root"
@@ -843,6 +870,20 @@
     clean_package_cache
 fi
 
+if [ "$ARCH" = "armv5tel" ] || [ "$ARCH" = "armv7l" ];then
+    echo "Building on Native ARM"
+    IS_NATIVE=1
+    if [ "$ARCH" = "armv5tel" ];then
+
+    if [ "$DIST" = "karmic"] || [ "$DIST" = "lucid" ];then
+      echo "only jaunty is supported for armv5"
+      exit 1
+    fi
+
+    fi
+fi
+
+if [ ! "$IS_NATIVE" ];then
 if [ ! $(which qemu-system-arm) ];then
     echo "qemu not installed, please use:"
     echo "sudo apt-get install qemu"
@@ -850,6 +891,7 @@
     echo "to install the qemu package !"
     exit 1
 fi
+fi
 
 if [ ! $(which debootstrap) ];then
     echo "debootstrap not installed, please use:"
@@ -924,6 +966,10 @@
 
 echo "${FQDN}" >$ROOTFS/etc/hostname
 
+if [ "$IS_NATIVE" ];then
+    touch $MOUNTPOINT/etc/is_native
+fi
+
 if [ "$KERNEL_IMAGE" ];then
     setup_kernel_image
 fi
@@ -972,9 +1018,13 @@
 #fi
 ${EXRA_MIRROR_CMD}
 
-ifconfig lo up
-ifconfig eth0 up
-dhclient eth0
+if [ -e /etc/is_native ]; then
+    echo "Networking already setup"
+else
+    ifconfig lo up
+    ifconfig eth0 up
+    dhclient eth0
+fi
 
 locale-gen --no-purge en_GB.UTF-8 || true
 locale-gen --no-purge ${NEWLOCALE} || true
@@ -1041,9 +1091,13 @@
     rm -f /rootstock-user-script
 fi
 
-mount -n -o remount,ro -t ext3 /dev/sda / || true
-
-rm /bin/installer && reboot -fp
+if [ -e /etc/is_native ]; then
+    rm /bin/installer
+    rm /etc/is_native
+else
+    mount -n -o remount,ro -t ext3 /dev/sda / || true
+    rm /bin/installer && reboot -fp
+fi
 
 EOF
 
@@ -1063,15 +1117,21 @@
 mv $BUILDDIR/installer $ROOTFS/bin/ >>$LOG 2>&1
 chmod +x $ROOTFS/bin/installer >>$LOG 2>&1
 
+if [ ! "$IS_NATIVE" ];then
 if [ "$NOROOT" ];then
     # if user, creates the ext3 fs for qemu, based on the rootfs
     create_rootfs_image
 else
     umount_image
 fi
+fi
 
-# run vm for second stage
-run_vm
+if [ "$IS_NATIVE" ];then
+    run_arm_chroot
+else
+    # run vm for second stage
+    run_vm
+fi
 
 # cache packages on host machine
 if [ "$COPY_PACKAGE_CACHE" ];then

