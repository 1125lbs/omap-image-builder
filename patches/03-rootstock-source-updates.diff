=== modified file 'rootstock'
--- rootstock	2011-02-03 15:31:05 +0000
+++ rootstock	2011-02-03 16:36:59 +0000
@@ -39,6 +39,8 @@
 PROGRAM="$(basename $0)"
 VERSION="0.1.99.4"
 
+unset IS_DEBIAN
+
 log()
 {
     [ $QUIET ] || echo "$*"
@@ -490,7 +492,7 @@
 {
     log "I: Setting up serial tty in image"
 
-    if [ "$DIST" = "jaunty" ];then
+    if [ "$DIST" = "jaunty" ] || [ "$DIST" = "lenny" ];then
         test -d $ROOTFS/etc/event.d/|| mkdir -p $ROOTFS/etc/event.d/
         cat > $ROOTFS/etc/event.d/$SERIAL_TTYS <<EOF
 start on runlevel 2
@@ -791,10 +793,12 @@
         -m|--mirror)
             MIRROR="$2"
             shift 2
+            DEB_MIRROR=1
             ;;
         -c|--components)
             COMPONENTS="$(echo $2|tr ',' ' ')"
             shift 2
+            DEB_COMPONENTS=1
             ;;
         -t|--timezone)
             if [ ! "$(echo $2|grep '/')" ];then
@@ -922,6 +926,16 @@
     usage
 fi
 
+if [ "$DIST" = "lenny" ] || [ "$DIST" = "squeeze" ] || [ "$DIST" = "sid" ];then
+
+    if [ ! $DEB_MIRROR ] && [ ! $DEB_COMPONENTS };then
+		echo "for debian add: --mirror http://ftp.us.debian.org/debian/"
+		echo "and add: --components \"main contrib\""
+		usage
+	fi
+    IS_DEBIAN=1
+fi
+
 # we need root
 if [ $(id -u) != 0 ] && [ ! "$NOROOT" ];then
     echo "You should run $PROGRAM as root unless you explicitly request it by giving --no-root"
@@ -1103,8 +1117,8 @@
     dhclient eth0
 fi
 
-locale-gen --no-purge en_GB.UTF-8 || true
-locale-gen --no-purge ${NEWLOCALE} || true
+which locale-gen >/dev/null 2>&1 && locale-gen --no-purge en_GB.UTF-8 || true
+which locale-gen >/dev/null 2>&1 && locale-gen --no-purge ${NEWLOCALE} || true
 echo LANG=${NEWLOCALE} >>/etc/default/locale
 
 sed -i -e 's/^XKBMODEL=.*\$/XKBMODEL="${XKBM}"/' /etc/default/console-setup || true
@@ -1159,7 +1173,17 @@
 
 ${PACKAGE_CLEANUP_SUB}
 
-passwd -l root || true
+if [ "$IS_DEBIAN" ];then
+
+passwd <<ROOTPASSWD
+root
+root
+ROOTPASSWD
+
+#if which dpkg-vendor >/dev/null 2>&1 && [ "`dpkg-vendor --query vendor`" = Ubuntu ]; then
+else
+  passwd -l root || true
+fi
 
 rm -f /usr/sbin/invoke-rc.d
 dpkg-divert --remove --rename /usr/sbin/invoke-rc.d

